#include <stdio.h>
#include <stdlib.h>
#include <graphics.h>
#include <conio.h>
#include <time.h>

int change_top[3];
int change_bot[3];

void generate_hole(int walltype, int i){

  switch (walltype) {   
    case 1:
      change_top[i] = 300;
      change_bot[i] = 470;
      break;

    case 2:
      change_top[i] = 400;
      change_bot[i] = 600;
      break;

    case 3:
      change_top[i] = 200;
      change_bot[i] = 360;
      break;

    case 4:
      change_top[i] = 400;
      change_bot[i] = 620;
      break;

    case 5:
      change_top[i] = 100;
      change_bot[i] = 375;
      break;

    default:
    break;
  }
}

struct Character{
  int left;
  int top; 
  int right; 
  int bottom; 

};

struct Wall{
  int left;
  int top; 
  int right; 
  int bottom; 
};

int get_random_num(){

  int max = 5;
  int min = 1;

  int ran_num = rand() % (max - min + 1) + min;

  return ran_num;

}

int main(){

  srand(time(NULL));

  char key_input;
  int game_end = 0;
  int velocity = 1;
  int accleration = 1;


  int wall_reset[3] = {1,1,1};

  int walltype;

  int wl = 600;
  int wr = 650;

  int top_wall_top[3], top_wall_bottom[3], top_wall_left[3], top_wall_right[3];

  int bot_wall_top[3], bot_wall_bottom[3], bot_wall_left[3], bot_wall_right[3];
  
  struct Character *bird; 

  struct Wall *walls[3];

  for(int i=0; i< 3; i++){
    walls[i] = (struct Wall *) malloc(sizeof(struct Wall));

    if(walls[i] == NULL){
      printf("Error creating wall");
      return -1;
    }
  }
  
  walls[0]->left = wl;
  walls[0]->top = 0;
  walls[0]->right = wr;
  walls[0]->bottom = 700;

  for(int i=1; i<3; i++){
    walls[i]->left = walls[i-1]->left+300;
    walls[i]->top = 0;
    walls[i]->right = walls[i-1]->right+300;
    walls[i]->bottom = 700;
  }

  bird = (struct Character *) malloc(sizeof(struct Character));


  if(bird == NULL){
    printf("Errror creating Character.");
    return -1;
  }

  //INITIAL BIRD POSITION
  bird->left = 100;
  bird->top = 325;
  bird->right = 125;
  bird->bottom = 300;

  initwindow(650,700,"Flappy Bird");

  setfillstyle(SOLID_FILL, WHITE);

  setcolor(WHITE);

  int page = 0;

  while(1){

    setactivepage(page);
    setvisualpage(1-page);
    cleardevice();


    setfillstyle(SOLID_FILL, YELLOW);
    setcolor(WHITE);

    rectangle(bird->left,bird->top,bird->right,bird->bottom);
    bar(bird->left,bird->top,bird->right, bird->bottom);


    //DRAW WALLS
    for(int i=0; i<3; i++){

      setcolor(WHITE);
      setfillstyle(SOLID_FILL, GREEN);

      if(wall_reset[i]){
        walltype = get_random_num();
        generate_hole(walltype, i);

        wall_reset[i] = 0;
      }

      top_wall_top[i] = walls[i]->top;
      // top_wall_bottom[i] = walls[i]->bottom - 500;
      top_wall_bottom[i] = change_top[i];
      top_wall_left[i] = walls[i]->left;
      top_wall_right[i] = walls[i]->right;

      bot_wall_top[i] = change_bot[i];
      bot_wall_bottom[i] = walls[i]->bottom;
      bot_wall_left[i] = walls[i]->left;
      bot_wall_right[i] = walls[i]->right;

      if(walls[i]->right >= 0 && walls[i]->left <= getmaxx()){
        rectangle(walls[i]->left, top_wall_top[i], walls[i]->right, top_wall_bottom[i]);
        bar(walls[i]->left, top_wall_top[i], top_wall_right[i], top_wall_bottom[i]);

        rectangle(walls[i]->left, bot_wall_top[i], walls[i]->right, bot_wall_bottom[i]);
        bar(walls[i]->left, bot_wall_top[i], bot_wall_right[i], bot_wall_bottom[i]);
      }

      if(walls[0]->left < 0 && walls[0]->right < 650){
        walls[0]->left = wl+300;
        walls[0]->right = wr+300;
        wall_reset[0] = 1;
      }

      if(walls[1]->left < 0 && walls[1]->right < 650){
        walls[1]->left = wl+300;
        walls[1]->right = wr+300;
        wall_reset[1] = 1;
      }

      if(walls[2]->left < 0 && walls[2]->right < 650){
        walls[2]->left = wl+300;
        walls[2]->right = wr+300;
        wall_reset[2] = 1;
      }

    }


    if(kbhit()){
      key_input = getch();

      switch (key_input) {

        case 'q':
          game_end = 1;
          return 0;
          break;

        case 32:
          if(bird->top > 25){
            bird->top -= 45;
            bird->bottom -= 45;
            velocity = 1;
          }

        default:
          break;
      }
    }

    //DETECT IF BIRD TOUCHES BOTTOM OF THE SCREEN
    if(bird->bottom < 670){
      bird->top += velocity;
      bird->bottom += velocity;
      if(velocity < 12){
        velocity += accleration;
      }
    }else{
      game_end = 1;
    }

    //WALL COLLISION DETECTION

    for(int i=0; i<3; i++){
      if(
        (
          (bird->left + 25 >= top_wall_left[i]) &&
          (bird->left <= top_wall_left[i] + 50) &&
          (bird->top+ 25 >= top_wall_bottom[i]) &&
          (bird->bottom <= top_wall_top[i] + change_top[i]) 
        ) || 
        (
          (bird->left + 25 >= bot_wall_left[i]) &&
          (bird->left <= bot_wall_left[i] + 50) &&
          (bird->top + 25 >= bot_wall_top[i]) &&
          (bird->bottom <= bot_wall_bottom[i] + change_bot[i]) 
        )
      )
      {
        game_end = 1;
        return 0;
      }
    }

    for(int i=0; i<3; i++){
      walls[i]->left -= 5;
      walls[i]->right -= 5;
    }

    if(game_end){
      return 0;
      break;
    }

    delay(16);
    page = 1 - page;
  }

  getch();
  closegraph();
  

  return 0;
}
